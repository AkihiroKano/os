#!/bin/bash
source_dir="$HOME/source"
backup_root="Backup-"
current_date=$(date +%Y-%m-%d)
backup_dir=""
report_file="backup-report"

find_backup() {
    find . -maxdepth 1 -type d -name "Backup-*" -mtime -7 -print -quit
}

existing_backup=$(find_backup)
if [ -n "$existing_backup" ]; then
    backup_dir="$existing_backup"
else
    backup_dir="${backup_root}${current_date}"
    mkdir -p "$backup_dir" || { echo "Ошибка: не удалось создать каталог." >&2; exit 1; }
    echo "Создан новый каталог: $backup_dir ($current_date)" >> "$report_file"
    find "$source_dir" -type f -print0 | while IFS= read -r -d '' file; do
        cp -r -- "$file" "$backup_dir/$(basename -- "$file")" || { echo "Ошибка копирования." >&2; exit 1; }
        echo "Скопирован: $(basename -- "$file")" >> "$report_file"
    done
    exit 0
fi

echo "Обновление резервной копии: $backup_dir ($current_date)" >> "$report_file"
find "$source_dir" -type f -print0 | while IFS= read -r -d '' file; do
    name=$(basename -- "$file")
    src="$file"
    dst="$backup_dir/$name"
    if [ ! -f "$dst" ]; then
        cp -- "$src" "$dst" && echo "Добавлен: $name" >> "$report_file"
    else
        src_size=$(stat -c %s -- "$src")
        dst_size=$(stat -c %s -- "$dst")
        if [ "$src_size" -ne "$dst_size" ]; then
            mv -- "$dst" "$dst.$current_date" && cp -- "$src" "$dst" || { echo "Ошибка версионирования." >&2; exit 1; }
            echo "Обновлен: $name -> $name.$current_date" >> "$report_file"
        fi
    fi
done
